---
title: "step2function"
output: html_notebook
---

```{r}
# Necessary libraries

library(sf)
library(dplyr)
library(stringr)
library(purrr)
```

```{r}
# Install if needed
#install.packages(c("tigris", "sf", "ggplot2"))
```

```{r}
#url <- https://www2.census.gov/geo/tiger/TIGER2023/ROADS/
# tested on first availible zip file
  
# function to process, unzip, read, and return a datframe of GEOID, road suffixes, and their counts for a county given a counties zip file

process_county_roads_zip <- function(zip_file) {
  
  # 1. Extract GEOID
  geoid <- str_extract(basename(zip_file), "\\d{5}")
  
  # 2. Create temp directory
  temp_dir <- tempfile()
  dir.create(temp_dir)
  
  # 3. Unzip safely
  unzip(zip_file, exdir = temp_dir)
  
  # 4. Find shapefile
  shp_file <- list.files(temp_dir, pattern = "\\.shp$", full.names = TRUE)
  
  # 5. Read shapefile
  roads <- st_read(shp_file[1], quiet = TRUE)
  
  # 6. Extract suffix
  if ("SUFTYP" %in% names(roads)) {
    roads$suffix <- roads$SUFTYP
  } else if ("FULLNAME" %in% names(roads)) {
    roads$suffix <- str_extract(roads$FULLNAME, "\\b\\w+$")
  } else {
    return(NULL)
  }
  
  # 7. Clean suffix
  roads <- roads %>%
    dplyr::mutate(
      suffix = str_to_upper(suffix),
      suffix = str_replace_all(suffix, "\\.", ""),
      suffix = str_trim(suffix)
    )
  
  # 8. Count
  out <- roads %>%
    st_drop_geometry() %>%
    filter(!is.na(suffix), suffix != "") %>%
    count(GEOID = geoid, suffix, name = "n")
  
  # 9. Cleanup temp files
  unlink(temp_dir, recursive = TRUE)
  
  return(out)
}
```

```{r}
df <- process_county_roads_zip("tl_2023_01001_roads.zip")
print(df)
```

```{r}

# function to return dataframe with a counties most common suffix 

df2 <- process_county_most_common_suffix <- function(suffix_df) {
  suffix_df %>%
    group_by(GEOID) %>%
    slice_max(n, n = 1, with_ties = FALSE)
}
```

```{r}
process_county_most_common_suffix(df)
print(df2)
```
