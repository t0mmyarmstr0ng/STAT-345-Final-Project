---
title: "step2function"
output: html_notebook
---

```{r}
# Necessary libraries

library(sf)
library(dplyr)
library(stringr)
library(purrr)
```

```{r}
# Install if needed
#install.packages(c("tigris", "sf", "ggplot2"))
```

```{r}
#url <- https://www2.census.gov/geo/tiger/TIGER2023/ROADS/
# tested on first availible zip file
  
# function to process, unzip, read, and return a datframe of GEOID, road suffixes, and their counts for a county given a counties zip file

process_county_roads_zip <- function(zip_file) {
  
  # 1. Extract GEOID
  geoid <- str_extract(basename(zip_file), "\\d{5}")
  
  # 2. Create temp directory
  temp_dir <- tempfile()
  dir.create(temp_dir)
  
  # 3. Unzip safely
  unzip(zip_file, exdir = temp_dir)
  
  # 4. Find shapefile
  shp_file <- list.files(temp_dir, pattern = "\\.shp$", full.names = TRUE)
  
  # 5. Read shapefile
  roads <- st_read(shp_file[1], quiet = TRUE)
  
  # 6. Extract suffix
  if ("SUFTYP" %in% names(roads)) {
    roads$suffix <- roads$SUFTYP
  } else if ("FULLNAME" %in% names(roads)) {
    roads$suffix <- str_extract(roads$FULLNAME, "\\b\\w+$")
  } else {
    return(NULL)
  }
  
  # 7. Clean suffix
  roads <- roads %>%
    dplyr::mutate(
      suffix = str_to_upper(suffix),
      suffix = str_replace_all(suffix, "\\.", ""),
      suffix = str_trim(suffix)
    )
  
  # 8. Count
  out <- roads %>%
    st_drop_geometry() %>%
    filter(!is.na(suffix), suffix != "") %>%
    count(GEOID = geoid, suffix, name = "n") %>%
    slice_max(n, n=1, with_ties = FALSE)
  
  # 9. Cleanup temp files
  unlink(temp_dir, recursive = TRUE)
  
  return(out)
}
```

```{r}
# Folder Wrapper Function
process_county_roads_folder <- function(folder_path) {
  # Get each file from folder
  zip_files <- list.files(
    folder_path,
    pattern = "\\.zip$",
    full.names = TRUE
  )
  
  # Apply function to each folder
  results <- purrr::map_dfr(
    zip_files,
    process_county_roads_zip
  )
    
  return(results)
}
```

```{r}
# (PROPORTION FUNCTION)
process_county_roads_zip_prop <- function(zip_file) {
  
  # 1. Extract GEOID
  geoid <- str_extract(basename(zip_file), "\\d{5}")
  
  # 2. Create temp directory
  temp_dir <- tempfile()
  dir.create(temp_dir)
  
  # 3. Unzip safely
  unzip(zip_file, exdir = temp_dir)
  
  # 4. Find shapefile
  shp_file <- list.files(temp_dir, pattern = "\\.shp$", full.names = TRUE)
  
  # 5. Read shapefile
  roads <- st_read(shp_file[1], quiet = TRUE)
  
  # 6. Extract suffix
  if ("SUFTYP" %in% names(roads)) {
    roads$suffix <- roads$SUFTYP
  } else if ("FULLNAME" %in% names(roads)) {
    roads$suffix <- str_extract(roads$FULLNAME, "\\b\\w+$")
  } else {
    return(NULL)
  }
  
  # 7. Clean suffix
  roads <- roads %>%
    dplyr::mutate(
      suffix = str_to_upper(suffix),
      suffix = str_replace_all(suffix, "\\.", ""),
      suffix = str_trim(suffix)
    )
  
  # 8. Drop geometry, remove missing
  roads_clean <- roads %>%
    st_drop_geometry() %>%
    filter(!is.na(suffix), suffix != "") %>%
    count(suffix, name = "n")
  
  # 9. Total roads
  total_roads <- roads_clean %>%
    summarise(total = sum(n)) %>%
    pull(total)
  
  # 10. Most common suffix
  top_suffix <- roads_clean %>%
    slice_max(n, n = 1, with_ties = FALSE)
  
  # 11. Add proportion
  out <- top_suffix %>%
    mutate(
      GEOID = geoid,
      proportion = n / total_roads
    ) %>%
    select(GEOID, suffix, n, proportion)
  
  # 12. Cleanup temp files
  unlink(temp_dir, recursive = TRUE)
  
  return(out)
}
```

```{r}
# Folder Wrapper Function (PROPORTION FUNCTION)
process_county_roads_folder_prop <- function(folder_path) {
  # Get each file from folder
  zip_files <- list.files(
    folder_path,
    pattern = "\\.zip$",
    full.names = TRUE
  )
  
  # Apply function to each folder
  results <- purrr::map_dfr(
    zip_files,
    process_county_roads_zip_prop
  )
    
  return(results)
}
```

```{r}
df <- process_county_roads_zip("tl_2023_01001_roads.zip")
print(df)
```

```{r}
df <- process_county_roads_folder("C:\\Users\\mwags\\Downloads\\StatFinalTest")
print(df)
```

```{r}
df <- process_county_roads_folder_prop("C:\\Users\\mwags\\Downloads\\StatFinalTest")
print(df)
```
