---
title: "345-Final-Work"
author: "Tommy Armstrong"
date: "2025-11-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Creating initial US County Map

```{r}
#install.packages("tigris")

# Load library
library(tigris)

# Download county boundaries for the whole U.S.
counties <- counties(cb = TRUE)

# Install if needed
install.packages(c("tigris", "sf", "ggplot2"))

library(tigris)
library(sf)
library(ggplot2)

# Get all U.S. counties (simplified)
counties <- counties(cb = TRUE)

# Convert to sf object if needed
counties_sf <- st_as_sf(counties)

county_plot = ggplot(data = counties_sf) +
  geom_sf(fill = "white", color = "gray40", size = 0.2) +
  coord_sf(
    xlim = c(-125, -66),   # longitude range (West to East)
    ylim = c(24, 50)       # latitude range (South to North)
  ) +
  theme_minimal() +
  labs(title = "U.S. County Boundaries (Contiguous States)",
       caption = "Source: U.S. Census Bureau TIGER/Line Shapefiles")
```

## Attempt to download files, not final code

```{r}
#Download every zip file into single folder

library(rvest)
library(purrr)

# URL of the directory
base_url <- "https://www2.census.gov/geo/tiger/TIGER2023/ROADS/"

# Read the HTML directory listing
page <- read_html(base_url)

# Extract all .zip file names
zip_files <- page %>%
  html_nodes("a") %>%
  html_attr("href") %>%
  grep("\\.zip$", ., value = TRUE)

zip_files
# Example: "tl_2023_01001_roads.zip", etc.

# Create download folder
dir.create("tiger_roads_2023", showWarnings = FALSE)

# Download each zip file
walk(zip_files, ~{
  download.file(
    url = paste0(base_url, .x),
    destfile = file.path("tiger_roads_2023", .x),
    mode = "wb"
  )
})


#install.packages("RSelenium")
#install.packages("netstat")

library(tidyverse)
library(RSelenium)
library(netstat)

#Connecting to server
rs_driver_object = rsDriver(
  browser = 'chrome',
  chromever = NULL,
  verbose = FALSE,
  port = free_port()
)

system("chrome --version")              # Mac


system('wget -r -np -nd -A zip https://www2.census.gov/geo/tiger/TIGER2023/ROADS/')
```

## Attempt to download files, not final code

```{r}
library(rvest)
library(httr)
library(purrr)
library(fs)

url <- "https://www2.census.gov/geo/tiger/TIGER2023/ROADS/"   # change this

# Get all links on the page
page <- read_html(url)
files <- page %>% html_nodes("a") %>% html_attr("href")

# Keep only files (not parent dirs)
files <- files[grepl("\\.(csv|txt|zip|pdf|xlsx)$", files, ignore.case = TRUE)]

# Turn into full URLs
file_urls <- paste0(url, files)
file_urls


##############################################

for (i in year_start:year_last){
  j=c(1:4)
  for (m in j){
    link.stem <- "https://www2.census.gov/geo/tiger/TIGER2023/ROADS/"
    url1<-paste0(link.stem,i,"/demo",i,"q",m,".csv.zip")
    download.file(url1,dest="data.zip") # Demography
    unzip ("data.zip")
   
    
    
     
start = "tl_2023_"
pattern = "\\d{5}"
end = "_roads.zip"


dir.create("tiger_roads_2023_attempt_2", showWarnings = FALSE)


#for (files in 1:100){
#  download.file(file_urls[files], dest = paste0(pattern, end)),
#  destfile = file.path("tiger_roads_2023_attempt_2", .x),
#}


dir.create("tiger_roads_2023_attempt_2", showWarnings = FALSE)

for (files in 5:10){
  fname <- basename(file_urls[files])
  download.file(
    url = file_urls[files],
    destfile = file.path("tiger_roads_2023_attempt_2", fname),
    mode = "wb"
  )
}

#Map_df

head(file_urls, 10)

```

## Actual working code for downloading files

```{r}
dir.create("tiger_roads_2023_attempt_2", showWarnings = FALSE)

for (files in 930:940){
  fname <- basename(file_urls[files])
  download.file(
    url = file_urls[files],
    destfile = file.path("tiger_roads_2023_attempt_2", fname),
    mode = "wb"
  )
}

head(file_urls, 10)

dir.create("tiger_roads_2023_attempt_3", showWarnings = FALSE)

chunk_size <- 25
total_downloads <- 3233

for (start_i in seq(937, total_downloads, by = chunk_size)) {
  end_i <- min(start_i + chunk_size - 1, total_downloads)
  cat("Downloading files", start_i, "to", end_i, "\n")
  for (i in start_i:end_i) {
    fname <- basename(file_urls[i])
    download.file(
      url = file_urls[i],
      destfile = file.path("tiger_roads_2023_attempt_3", fname),
      mode = "wb"
    )
  }
}

#20077 is  number 929
#940
#Code crashed once during downloading, this is to track where we were in the download process

```

## Running function on code folder

```{r}
finished_download = process_county_roads_folder("//Users//tommyarmstrong//Desktop//tiger_roads_2023_attempt_3//")


#Create CSV to share
write.csv(finished_download, "finished_download.csv", row.names = FALSE)

#Read in the finished data for part 1
plot1data = read.csv("finished_download.csv")

```

## Function and dataset making for plot 2

```{r}
# (PROPORTION FUNCTION)
process_county_roads_zip_prop <- function(zip_file) {
  
  # 1. Extract GEOID
  geoid <- str_extract(basename(zip_file), "\\d{5}")
  
  # 2. Create temp directory
  temp_dir <- tempfile()
  dir.create(temp_dir)
  
  # 3. Unzip safely
  unzip(zip_file, exdir = temp_dir)
  
  # 4. Find shapefile
  shp_file <- list.files(temp_dir, pattern = "\\.shp$", full.names = TRUE)
  
  # 5. Read shapefile
  roads <- st_read(shp_file[1], quiet = TRUE)
  
  # 6. Extract suffix
  if ("SUFTYP" %in% names(roads)) {
    roads$suffix <- roads$SUFTYP
  } else if ("FULLNAME" %in% names(roads)) {
    roads$suffix <- str_extract(roads$FULLNAME, "\\b\\w+$")
  } else {
    return(NULL)
  }
  
  # 7. Clean suffix
  roads <- roads %>%
    dplyr::mutate(
      suffix = str_to_upper(suffix),
      suffix = str_replace_all(suffix, "\\.", ""),
      suffix = str_trim(suffix)
    )
  
  # 8. Drop geometry, remove missing
  roads_clean <- roads %>%
    st_drop_geometry() %>%
    filter(!is.na(suffix), suffix != "") %>%
    count(suffix, name = "n")
  
  # 9. Total roads
  total_roads <- roads_clean %>%
    summarise(total = sum(n)) %>%
    pull(total)
  
  # 10. Most common suffix
  top_suffix <- roads_clean %>%
    slice_max(n, n = 1, with_ties = FALSE)
  
  # 11. Add proportion
  out <- top_suffix %>%
    mutate(
      GEOID = geoid,
      proportion = n / total_roads
    ) %>%
    select(GEOID, suffix, n, proportion)
  
  # 12. Cleanup temp files
  unlink(temp_dir, recursive = TRUE)
  
  return(out)
}

# Folder Wrapper Function (PROPORTION FUNCTION)
process_county_roads_folder_prop <- function(folder_path) {
  # Get each file from folder
  zip_files <- list.files(
    folder_path,
    pattern = "\\.zip$",
    full.names = TRUE
  )
  
  # Apply function to each folder
  results <- purrr::map_dfr(
    zip_files,
    process_county_roads_zip_prop
  )
    
  return(results)
}

plot2data = process_county_roads_folder_prop("//Users//tommyarmstrong//Desktop//tiger_roads_2023_attempt_3//")

write.csv(plot2data, "plot2data.csv", row.names = FALSE)
```

## Plot 3 Data and work

```{r}
hospital.data = read.csv("Hospital_General_Information.csv")


#Hospital data set
hospital.data = hospital.data |> 
  mutate(county.name = tolower(County.Parish)) |> 
  select(Address, City.Town, State, Hospital.Type, county.name)

#US county data set
counties_sf = counties_sf |> 
  mutate(county.name = tolower(NAME)) |> 
  rename(State = STUSPS)

#combining the two 
plot3data = left_join(counties_sf, hospital.data, by = c("county.name", "State"))

#Cleaning the combined data set
plot3data = plot3data |> 
  select(Address, county.name, State, Hospital.Type, GEOID, ALAND, AWATER, geometry) |>
  group_by(county.name, State) |>
  mutate(hospital.per.county = n())

head(plot3data)

#turning dataset back into sf file
class(plot3data)
plot3data = sf::st_as_sf(plot3data)

class(plot3data)
plot3data = sf::st_as_sf(plot3data)


#Making plot
plot3 = plot3data |>
  ggplot() +
  geom_sf(aes(fill = hospital.per.county), color = NA, size = .2) +
  coord_sf(
    xlim = c(-125, -66),
    ylim = c(24, 50)
  ) +
  scale_fill_viridis_c(
    trans = "log10",
    option = "plasma", 
    name = "Hospitals per County") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid = element_blank()
  ) +
  labs(
    title = "Number of Hospitals in each U.S. County")


#Showing plot
plot3
```
